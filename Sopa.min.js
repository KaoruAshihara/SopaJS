Sopa=function(Da){this.urlStr=Da;var ea=navigator.userAgent.toLowerCase(),fa=!1,oa=!1,sa=!1,ta=!1,ua=!0,Y=0,va,wa,G=new XMLHttpRequest,C=new XMLHttpRequest,K=new Int16Array(130048),h=new Int16Array(130048),U,Z,H,I,n,pa=0,L,u=0,qa,V=0,W=0,X=0,aa=0,ra,M,N,xa,z,ba,ca,ya,t=0,ha=36,ia=18,ja,da=Array(256),ka=[],la=[0,0,-1],ma=0,za=new Float32Array(2229),Aa=new Float32Array(2229),Ba=Math.PI/2;this.setup=function(){-1<ea.indexOf("iphone")||-1<ea.indexOf("ipod")||-1<ea.indexOf("ipad")?sa=!0:ea.indexOf("android");
try{xa=window.AudioContext||window.webkitAudioContext,z=new xa}catch(Ca){return alert("Web Audio API is not supported in this browser"),!1}ca=z.sampleRate;if(0==u)return alert("SOPA data not available!"),!1;ya=ca/u;ha=36;ia=18;V=4096;L=0;ja=new Float32Array(t);var a=t/8;for(var c=0;c<t;c++)ja[c]=c<a?(1-Math.cos(Math.PI*c/a))/4:c>=t-a?(1-Math.cos(Math.PI*(t-c)/a))/4:.5;for(a=0;254>a;a++)ka[a]=this.initCoord(a);for(c=0;256>c;c++){da[c]=Array(72);for(var b=0;72>b;b++){da[c][b]=Array(36);a=36<=b?Math.PI*
(b-36)/36:-Math.PI*(36-b)/36;for(var d=-18;18>d;d++){var g=Math.PI*d/36;g=this.modifySector(c,a,g);da[c][b][d+18]=Math.floor(g)}}}ba=z.createScriptProcessor(V,2,2);return!0};this.loadDatabase=function(a,c){va=a;wa=c;G.open("GET",va,!0);G.responseType="arraybuffer";G.onreadystatechange=this.handleHrtf;G.send(null);C.open("GET",wa,!0);C.responseType="arraybuffer";C.onreadystatechange=this.handlePhase;C.send(null)};Sopa.prototype.handleHrtf=function(){4==G.readyState&&200==G.status&&(K=new Int16Array(G.response),
ma++,1<ma&&(oa=!0))};Sopa.prototype.handlePhase=function(){4==C.readyState&&200==C.status&&(h=new Int16Array(C.response),ma++,1<ma&&(oa=!0))};this.loadSopaData=function(){this.loadSopa(this.handleSopa)};Sopa.prototype.loadSopa=function(a){var c=this,b=new XMLHttpRequest;b.open("GET",this.urlStr,!0);b.responseType="arraybuffer";b.onreadystatechange=function(){4==b.readyState&&(200!=b.status&&4==b.readyState?alert("HTTP error "+b.status):a.call(c,b))};b.send(null)};Sopa.prototype.handleSopa=function(a){a=
a.response;var c=((new DataView(a)).byteLength-44)/4;n=new Uint8Array(a,0,44);0==pa?(U=new Uint8Array(a,44,4*c),H=new Int16Array(a,44,2*c)):(Z=new Uint8Array(a,44,4*c),I=new Int16Array(a,44,2*c));0==aa&&(ua=this.checkHeader()?!0:!1);pa=0==pa?1:0};Sopa.prototype.checkHeader=function(){var a=new Uint8Array(4);for(c=8;12>c;c++)a[c-8]=n[c];if(83!=a[0]||79!=a[1]||80!=a[2]||65!=a[3])return alert("Data format error!"),!1;for(c=12;15>c;c++)a[c-12]=n[c];if(102!=a[0]||109!=a[1]||116!=a[2])return alert("Data format error!"),
!1;if(16!=n[16])return alert("PCM data should be 16-bit depth!"),!1;u=n[25]&255;u*=256;u+=n[24]&255;if(22050!=u&&44100!=u)return alert("Wrong sampleRate! "+u),!1;qa=n[39];if(2>qa)return alert("Sorry, this version is not supported"),!1;if(0==t){for(var c=5;255!=U[c]&&4096>=c;)c+=4;t=c-1;if(4096<t)return alert("Something wrong!"),!1;M=new Float32Array(t);N=new Float32Array(t)}return!0};this.fftWinSize=function(){return ua?t:0};this.databaseReady=function(){return oa};this.beingPlayed=function(){return fa};
this.Play=function(){this.play()};this.currentOffset=function(){return W};this.totalOffset=function(){return aa};this.getSampleRate=function(){return u};this.setLastLoop=function(a){ta=a};this.setUrl=function(a){this.urlStr=a};this.setPan=function(a){179<a?a=179:-180>a&&(a=-180);ha=Math.floor(36+a/5)};this.setTilt=function(a){89<a?a=89:-90>a&&(a=-90);ia=Math.floor(18+a/5)};this.setCardioid=function(a,c,b){Y=a;focus=void 0==c?-Math.PI:c-Math.PI;void 0==b&&(b=0);la[0]=Math.sin(focus);la[1]=Math.sin(b);
la[2]=Math.cos(focus)};Sopa.prototype.play=function(){var a=this;fa?(ba.disconnect(z.destination),ba.onaudioprocess=null,fa=!1):(ra=L=currenttime=W=X=aa=0,ba.onaudioprocess=function(c){a.Process.call(a,c)},sa&&z.createBufferSource().start(0),fa=!0,ba.connect(z.destination))};Sopa.prototype.Process=function(a){var c=t,b=2*t,d=c/2,g=c/2,Ca=1/ca,Ea=44100*c/(512*u),k,m,p=new Float32Array(c),r=new Float32Array(c),D=new Float32Array(c),na=new Float32Array(c),G=a.outputBuffer.getChannelData(0);a=a.outputBuffer.getChannelData(1);
var E=ra-X,F=za.subarray(0,E);G.set(F,0);F=Aa.subarray(0,E);a.set(F,0);X+=E;currenttime=X/ca;F=Math.ceil((V-E)/(ya*d));for(var C=0;C<F;C++){var l=2*W;if(0==L)if(l+b>H.length){var q=H.subarray(l,H.length);var e=null!=I?I.subarray(0,l+b-H.length):H.subarray(0,l+b-H.length);var w=new Int16Array(q.length+e.length);w.set(q);w.set(e,q.length)}else w=H.subarray(l,l+b);else l+b>I.length?(q=I.subarray(l,I.length),e=H.subarray(0,l+b-I.length),w=new Int16Array(q.length+e.length),w.set(q),w.set(e,q.length)):
w=I.subarray(l,l+b);q=new Float32Array(t);var A=new Float32Array(t);for(e=0;e<t;e++)q[e]=w[2*e+1];e={real:q,image:A};this.fastFt(e,!1);w=2*l;var n=w+c;r[g]=q[g]*Math.cos(A[g]);p[g]=q[g]*Math.cos(A[g]);na[g]=q[g]*Math.sin(A[g]);D[g]=q[g]*Math.sin(A[g]);for(e=0;e<g;e++){l=c-e;var x=Math.floor(e/Ea);var v=0==x?x:512-x;var y=0==L?0==e%2?U[w+2*e+1]:U[w+2*(e-1)]:0==e%2?Z[w+2*e+1]:Z[w+2*(e-1)];var B=3>qa?y:0==L?0==e%2?U[n+2*e+1]:U[n+2*(e-1)]:0==e%2?Z[n+2*e+1]:Z[n+2*(e-1)];if(0==x){if(B=x=q[e],v=y=A[e],0<
e){var O=k=q[l];var P=m=A[l]}}else if(254<=y&&254<=B)B=x=q[e],v=y=A[e],O=k=q[l],P=m=A[l];else{253<y?y=B:253<B&&(B=y);y=da[y][ha][ia];O=this.opposit(y);B=da[B][ha][ia];P=this.opposit(B);if(0<Y){k=this.initCoord(y);m=this.initCoord(B);k=this.getUnitVector(k,m);k=this.polar(la,k);var J=k[0];var z=k[1]}else J=1,z=0;J/=2048;var Q=512*y+x;var R=512*y+v;var f=K[Q]*J;var S=512*B+x;var T=512*B+v;f+=K[S]*J;f/=2;B=q[e]*f;f=h[Q]/1E4;f+=h[S]/1E4;f/=2;31416<Math.abs(h[Q]-h[S])&&(f=0>f?f+Math.PI:f-Math.PI);y=A[e]+
f+z;f=K[R]*J;f+=K[T]*J;f/=2;k=q[l]*f;f=h[R]/1E4;f+=h[T]/1E4;f/=2;31416<Math.abs(h[R]-h[T])&&(f=0>f?f+Math.PI:f-Math.PI);m=A[l]+f-z;Q=512*O+x;R=512*O+v;f=K[Q]*J;S=512*P+x;T=512*P+v;f+=K[S]*J;f/=2;x=q[e]*f;f=h[Q]/1E4;f+=h[S]/1E4;f/=2;31416<Math.abs(h[Q]-h[S])&&(f=0>f?f+Math.PI:f-Math.PI);v=A[e]+f+z;f=K[R]*J;f+=K[T]*J;f/=2;O=q[l]*f;f=h[R]/1E4;f+=h[T]/1E4;f/=2;31416<Math.abs(h[R]-h[T])&&(f=0>f?f+Math.PI:f-Math.PI);P=A[l]+f-z}r[e]=x*Math.cos(v);p[e]=B*Math.cos(y);na[e]=x*Math.sin(v);D[e]=B*Math.sin(y);
0<e&&(r[l]=O*Math.cos(P),p[l]=k*Math.cos(m),na[l]=O*Math.sin(P),D[l]=k*Math.sin(m))}e={real:r,image:na};this.fastFt(e,!0);e={real:p,image:D};this.fastFt(e,!0);for(e=0;e<c;e++)r[e]*=ja[e],p[e]*=ja[e],M[e]+=r[e],N[e]+=p[e];for(e=0;e<d;e++){q=M[e+1]/32768;A=N[e+1]/32768;l=M[e]/32768;w=N[e]/32768;for(n=aa/u;currenttime<n;)v=(n-currenttime)*u,x=l*v+q*(1-v),v=w*v+A*(1-v),E<V?(G[E]=x,a[E]=v,X++,currenttime=X/ca):(za[E-V]=x,Aa[E-V]=v,currenttime+=Ca),E++,ra++;aa++}e=M.subarray(d);M=new Float32Array(t);M.set(e,
0);e=N.subarray(d);N=new Float32Array(t);N.set(e,0);W+d>=(0==L?H.length/2:I.length/2)?ta?(C=F,this.play()):(W=0,L=0==L&&I?1:0):W+=d}};Sopa.prototype.fastFt=function(a,c){var b,d,g,h,n=t;var k=2*Math.PI;var m=a.real,p=a.image;if(!c)for(b=0;b<n;b++){p[b]=0;var r=(1-Math.cos(k*b/n))/2;m[b]*=r}b=Math.PI;for(k=r=0;k<n-1;k++){if(k<=r){var D=m[k];m[k]=m[r];m[r]=D;D=p[k];p[k]=p[r];p[r]=D}for(d=n/2;d<=r;)r-=d,d/=2;r+=d}var u=1;for(r=c?1:-1;u<=n/2;){var z=Math.cos(b);var E=Math.sin(r*b);k=1;for(g=d=0;g<u;g++){for(h=
g;h<n;h+=2*u){var F=h+u;D=m[F]*k-p[F]*d;var C=p[F]*k+m[F]*d;m[F]=m[h]-D;p[F]=p[h]-C;m[h]+=D;p[h]+=C}D=z*k-E*d;d=E*k+z*d;k=D}u*=2;b/=2}if(!c)for(b=0;b<n;b++)m[b]/=n,p[b]/=n,r=Math.sqrt(m[b]*m[b]+p[b]*p[b]),k=Math.atan2(p[b],m[b]),m[b]=r,p[b]=k};Sopa.prototype.initCoord=function(a){var c=Array(3),b=Math.PI/12;127<=a&&(b*=-1);if(0==a)c[0]=c[2]=0,c[1]=1;else if(253==a)c[0]=c[2]=0,c[1]=-1;else{if(9>a||245<=a){var d=Math.PI/4;var g=Math.cos(5*b);c[1]=Math.sin(5*b);a=9>a?d*(a-1)-Math.PI:d*(252-a)}else 25>
a||229<=a?(d=Math.PI/8,g=Math.cos(4*b),c[1]=Math.sin(4*b),a=25>a?d*(a-9)-Math.PI:d*(244-a)):49>a||205<=a?(d=Math.PI/12,g=Math.cos(3*b),c[1]=Math.sin(3*b),a=49>a?d*(a-25)-Math.PI:d*(228-a)):79>a||175<=a?(d=Math.PI/15,g=Math.cos(2*b),c[1]=Math.sin(2*b),a=79>a?d*(a-49)-Math.PI:d*(204-a)):111>a||143<=a?(d=Math.PI/16,g=Math.cos(b),c[1]=Math.sin(b),a=111>a?d*(a-79)-Math.PI:d*(174-a)):(d=Math.PI/16,g=1,c[1]=0,a=127>a?d*(a-111)-Math.PI:d*(142-a));c[0]=g*Math.sin(a);c[2]=g*Math.cos(a)}return c};Sopa.prototype.opposit=
function(a){return 0==a||253<=a?a:9>a?1==a?a:10-a:25>a?9==a?a:34-a:49>a?25==a?a:74-a:79>a?49==a?a:128-a:111>a?79==a?a:190-a:127>a?111==a?a:15+a:143>a?142==a?a:a-15:175>a?174==a?a:316-a:205>a?204==a?a:378-a:229>a?228==a?a:432-a:245>a?244==a?a:472-a:252==a?a:496-a};Sopa.prototype.modifySector=function(a,c,b){var d=0;if(253<a)return a;0!=a&&253!=a&&(d=Math.atan2(ka[a][0],ka[a][2])+c);var g=0==a||253==a?0:9>a||245<=a?Math.cos(5*Math.PI/12):25>a||229<=a?Math.cos(Math.PI/3):49>a||205<=a?Math.cos(Math.PI/
4):79>a||175<=a?Math.cos(Math.PI/6):111>a||143<=a?Math.cos(Math.PI/12):1;c=[];c[0]=g*Math.sin(d);c[2]=g*Math.cos(d);c[1]=ka[a][1];if(0!=b){g=c[0];a=c[1];var h=c[2];g=Math.sqrt(g*g+h*h);b=Math.atan2(a,g)+b;a=Math.sqrt(g*g+a*a);c[0]=a*Math.cos(b)*Math.sin(d);c[2]=a*Math.cos(b)*Math.cos(d);c[1]=a*Math.sin(b)}return this.calcSector(c)};Sopa.prototype.calcSector=function(a){var c=2*Math.PI;if(a[1]>=Math.sin(11*Math.PI/24))return 0;if(a[1]<=-Math.sin(11*Math.PI/24))return 253;var b=Math.atan2(-a[0],-a[2]);
a[1]>=Math.sin(3*Math.PI/8)?(0>b&&(b+=c),a=1+b/(Math.PI/4)):a[1]<=-Math.sin(3*Math.PI/8)?a=249-b/(Math.PI/4):a[1]>=Math.sin(7*Math.PI/24)?(0>b&&(b+=c),a=9+b/(Math.PI/8)):a[1]<=-Math.sin(7*Math.PI/24)?a=237-b/(Math.PI/8):a[1]>=Math.sin(5*Math.PI/24)?(0>b&&(b+=c),a=25+b/(Math.PI/12)):a[1]<=-Math.sin(5*Math.PI/24)?a=217-b/(Math.PI/12):a[1]>=Math.sin(Math.PI/8)?(0>b&&(b+=c),a=49+b/(Math.PI/15)):a[1]<=-Math.sin(Math.PI/8)?a=190-b/(Math.PI/15):a[1]>=Math.sin(Math.PI/24)?(0>b&&(b+=c),a=79+b/(Math.PI/16)):
a=a[1]<=-Math.sin(Math.PI/24)?159-b/(Math.PI/16):0>b?127-b/(Math.PI/16):b==Math.PI?142:111+b/(Math.PI/16);return a};Sopa.prototype.polar=function(a,c){var b=Array(2);var d=Math.acos(c[0]*a[0]+c[1]*a[1]+c[2]*a[2]);1==Y?(d=Ba*(1-Math.cos(d)*Math.cos(c[3])),b[0]=(1+Math.cos(d))/2,b[1]=Math.acos(b[0])):2==Y?(d=Math.PI/5*(1-Math.cos(d)*Math.cos(c[3])),b[0]=Math.cos(d/2)*Math.cos(d)*Math.cos(2*d)*Math.cos(4*d)*Math.cos(8*d),b[1]=Math.acos(b[0])):3==Y&&(d=Math.PI/5*(1-Math.cos(d)*Math.cos(c[3])),b[0]=Math.cos(d/
2)*Math.cos(d)*Math.cos(2*d)*Math.cos(4*d)*Math.cos(8*d),b[0]=b[0]*Math.cos(16*d)*Math.cos(32*d),b[1]=Math.acos(b[0]));b[0]=Math.abs(b[0]);return b};Sopa.prototype.getUnitVector=function(a,c){var b=[a[0]+c[0],a[1]+c[1],a[2]+c[2]];var d=a[0]*c[0]+a[1]*c[1]+a[2]*c[2];1<d?b.push(0):-1>d?b.push(Ba):b.push(Math.acos(d)/2);d=Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2]);0<d?(b[0]/=d,b[1]/=d,b[2]/=d):(b[0]=0,b[1]=1,b[2]=0);return b}};