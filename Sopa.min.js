Sopa=function(Ba){this.urlStr=Ba;var R=navigator.userAgent.toLowerCase(),ea=!1,na=!1,ra=!1,sa=!1,ta=!0,Z=0,ua,va,B=new XMLHttpRequest,I=new XMLHttpRequest,L=new Int16Array(130048),l=new Int16Array(130048),U,aa,J,K,F,oa=0,M,C=0,pa,V=0,W=0,X=0,ba=0,qa,N,O,wa,t,P,ca,xa,u=0,fa=36,ha=18,ia,da=Array(256),ja=[],ka=[0,0,-1],la=0,ya=new Float32Array(2229),za=new Float32Array(2229),Aa=Math.PI/2;this.setup=function(){-1<R.indexOf("iphone")||-1<R.indexOf("ipod")||-1<R.indexOf("ipad")?ra=!0:R.indexOf("android");
try{wa=window.AudioContext||window.webkitAudioContext,t=new wa,this.unlockAudioContext(t)}catch(h){return alert("Web Audio API is not supported in this browser"),!1}ca=t.sampleRate;if(0==C)return alert("SOPA data not available!"),!1;xa=ca/C;fa=36;ha=18;V=4096;M=0;ia=new Float32Array(u);var a=u/3;for(var c=0;c<u;c++)ia[c]=c<a?(.54-.46*Math.cos(Math.PI*c/a))/2:c>=u-a?(.54-.46*Math.cos(Math.PI*(u-c)/a))/2:.5;for(a=0;254>a;a++)ja[a]=this.initCoord(a);for(c=0;256>c;c++){da[c]=Array(72);for(var b=0;72>
b;b++){da[c][b]=Array(36);a=36<=b?Math.PI*(b-36)/36:-Math.PI*(36-b)/36;for(var d=-18;18>d;d++){var f=Math.PI*d/36;f=this.modifySector(c,a,f);da[c][b][d+18]=Math.floor(f)}}}P=t.createScriptProcessor(V,2,2);return!0};this.unlockAudioContext=function(a){function c(){a.resume().then(b)}function b(){f.forEach(function(a){return d.removeEventListener(a,c)})}if("suspended"===a.state){var d=document.body,f=["touchstart","touchend","mousedown","keydown"];f.forEach(function(a){return d.addEventListener(a,c,
!1)})}};this.loadDatabase=function(a,c){ua=a;va=c;B.open("GET",ua,!0);B.responseType="arraybuffer";B.onreadystatechange=this.handleHrtf;B.send(null);I.open("GET",va,!0);I.responseType="arraybuffer";I.onreadystatechange=this.handlePhase;I.send(null)};Sopa.prototype.handleHrtf=function(){4==B.readyState&&200==B.status&&(L=new Int16Array(B.response),la++,1<la&&(na=!0))};Sopa.prototype.handlePhase=function(){4==I.readyState&&200==I.status&&(l=new Int16Array(I.response),la++,1<la&&(na=!0))};this.loadSopaData=
function(){this.loadSopa(this.handleSopa)};Sopa.prototype.loadSopa=function(a){var c=this,b=new XMLHttpRequest;b.open("GET",this.urlStr,!0);b.responseType="arraybuffer";b.onreadystatechange=function(){4==b.readyState&&(200!=b.status&&4==b.readyState?alert("HTTP error "+b.status):a.call(c,b))};b.send(null)};Sopa.prototype.handleSopa=function(a){a=a.response;var c=((new DataView(a)).byteLength-44)/4;F=new Uint8Array(a,0,44);0==oa?(U=new Uint8Array(a,44,4*c),J=new Int16Array(a,44,2*c)):(aa=new Uint8Array(a,
44,4*c),K=new Int16Array(a,44,2*c));0==ba&&(ta=this.checkHeader()?!0:!1);oa=0==oa?1:0};Sopa.prototype.checkHeader=function(){var a=new Uint8Array(4);for(c=8;12>c;c++)a[c-8]=F[c];if(83!=a[0]||79!=a[1]||80!=a[2]||65!=a[3])return alert("Data format error!"),!1;for(c=12;15>c;c++)a[c-12]=F[c];if(102!=a[0]||109!=a[1]||116!=a[2])return alert("Data format error!"),!1;if(16!=F[16])return alert("PCM data should be 16-bit depth!"),!1;C=F[25]&255;C*=256;C+=F[24]&255;if(22050!=C&&44100!=C)return alert("Wrong sampleRate! "+
C),!1;pa=F[39];if(2>pa)return alert("Sorry, this version is not supported"),!1;if(0==u){for(var c=5;255!=U[c]&&4096>=c;)c+=4;u=c-1;if(4096<u)return alert("Something wrong!"),!1;N=new Float32Array(u);O=new Float32Array(u)}return!0};this.fftWinSize=function(){return ta?u:0};this.databaseReady=function(){return na};this.beingPlayed=function(){return ea};this.Play=function(){this.play()};this.currentOffset=function(){return W};this.totalOffset=function(){return ba};this.getSampleRate=function(){return C};
this.setLastLoop=function(a){sa=a};this.setUrl=function(a){this.urlStr=a};this.setPan=function(a){179<a?a=179:-180>a&&(a=-180);fa=Math.floor(36+a/5)};this.setTilt=function(a){89<a?a=89:-90>a&&(a=-90);ha=Math.floor(18+a/5)};this.setCardioid=function(a,c,b){Z=a;focus=void 0==c?-Math.PI:c-Math.PI;void 0==b&&(b=0);ka[0]=Math.sin(focus);ka[1]=Math.sin(b);ka[2]=Math.cos(focus)};Sopa.prototype.play=function(){var a=this;ea?(P.disconnect(t.destination),P.onaudioprocess=null,ea=!1):(qa=M=currenttime=W=X=ba=
0,P.onaudioprocess=function(c){a.Process.call(a,c)},ra&&t.createBufferSource().start(0),ea=!0,P.connect(t.destination))};Sopa.prototype.Process=function(a){var c=u,b=2*u,d=c/2,f=c/2,h=1/ca,Ca=44100*c/(512*C),k,p,n=0,r=new Float32Array(c),y=new Float32Array(c),ma=new Float32Array(c),B=new Float32Array(c),I=a.outputBuffer.getChannelData(0);a=a.outputBuffer.getChannelData(1);var w=qa-X,Y=ya.subarray(0,w);I.set(Y,0);Y=za.subarray(0,w);a.set(Y,0);X+=w;currenttime=X/ca;Y=Math.ceil((V-w)/(xa*d));for(var F=
0;F<Y;F++){var m=2*W;if(0==M)if(m+b>J.length){var q=J.subarray(m,J.length);var e=null!=K?K.subarray(0,m+b-J.length):J.subarray(0,m+b-J.length);var z=new Int16Array(q.length+e.length);z.set(q);z.set(e,q.length)}else z=J.subarray(m,m+b);else m+b>K.length?(q=K.subarray(m,K.length),e=J.subarray(0,m+b-K.length),z=new Int16Array(q.length+e.length),z.set(q),z.set(e,q.length)):z=K.subarray(m,m+b);q=new Float32Array(u);var D=new Float32Array(u);for(e=0;e<u;e++)q[e]=z[2*e+1];e={real:q,image:D};this.fastFt(e,
!1);z=2*m;var t=z+c;y[f]=q[f]*Math.cos(D[f]);r[f]=q[f]*Math.cos(D[f]);B[f]=q[f]*Math.sin(D[f]);ma[f]=q[f]*Math.sin(D[f]);for(e=0;e<f;e++){m=c-e;var A=Math.floor(e/Ca);var x=0==A?A:512-A;var v=0==M?0==e%2?U[z+2*e+1]:U[z+2*(e-1)]:0==e%2?aa[z+2*e+1]:aa[z+2*(e-1)];var E=3>pa?v:0==M?0==e%2?U[t+2*e+1]:U[t+2*(e-1)]:0==e%2?aa[t+2*e+1]:aa[t+2*(e-1)];if(0==A){if(E=A=q[e],x=v=D[e],0<e){var G=k=q[m];var H=p=D[m]}}else if(254<=v&&254<=E)E=A=q[e],x=v=D[e],G=k=q[m],H=p=D[m];else{253<v?v=E:253<E&&(E=v);if(0<=v&&
256>v){v=da[v][fa][ha];var P=this.opposit(v);E=da[E][fa][ha];var R=this.opposit(E);0<Z?(n=this.initCoord(v),k=this.initCoord(E),k=this.polar(ka,n,k)):k=1;n=0;var Q=k/2048}G=512*v+A;H=512*v+x;var g=L[G]*Q;var S=512*E+A;var T=512*E+x;g+=L[S]*Q;g/=2;E=q[e]*g;g=l[G]/1E4;g+=l[S]/1E4;g/=2;31416<Math.abs(l[G]-l[S])&&(g=0>g?g+Math.PI:g-Math.PI);v=D[e]+g+n;g=L[H]*Q;g+=L[T]*Q;g/=2;k=q[m]*g;g=l[H]/1E4;g+=l[T]/1E4;g/=2;31416<Math.abs(l[H]-l[T])&&(g=0>g?g+Math.PI:g-Math.PI);p=D[m]+g-n;G=512*P+A;H=512*P+x;g=L[G]*
Q;S=512*R+A;T=512*R+x;g+=L[S]*Q;g/=2;A=q[e]*g;g=l[G]/1E4;g+=l[S]/1E4;g/=2;31416<Math.abs(l[G]-l[S])&&(g=0>g?g+Math.PI:g-Math.PI);x=D[e]+g+n;g=L[H]*Q;g+=L[T]*Q;g/=2;G=q[m]*g;g=l[H]/1E4;g+=l[T]/1E4;g/=2;31416<Math.abs(l[H]-l[T])&&(g=0>g?g+Math.PI:g-Math.PI);H=D[m]+g-n}y[e]=A*Math.cos(x);r[e]=E*Math.cos(v);B[e]=A*Math.sin(x);ma[e]=E*Math.sin(v);0<e&&(y[m]=G*Math.cos(H),r[m]=k*Math.cos(p),B[m]=G*Math.sin(H),ma[m]=k*Math.sin(p))}e={real:y,image:B};this.fastFt(e,!0);e={real:r,image:ma};this.fastFt(e,!0);
for(e=0;e<c;e++)y[e]*=ia[e],r[e]*=ia[e],N[e]+=y[e],O[e]+=r[e];for(e=0;e<d;e++){q=N[e+1]/32768;D=O[e+1]/32768;m=N[e]/32768;z=O[e]/32768;for(t=ba/C;currenttime<t;)x=(t-currenttime)*C,A=m*x+q*(1-x),x=z*x+D*(1-x),w<V?(I[w]=A,a[w]=x,X++,currenttime=X/ca):(ya[w-V]=A,za[w-V]=x,currenttime+=h),w++,qa++;ba++}e=N.subarray(d);N=new Float32Array(u);N.set(e,0);e=O.subarray(d);O=new Float32Array(u);O.set(e,0);W+d>=(0==M?J.length/2:K.length/2)?sa?(F=Y,this.play()):(W=0,M=0==M&&K?1:0):W+=d}};Sopa.prototype.fastFt=
function(a,c){var b,d,f,h,l=u;var k=2*Math.PI;var p=a.real,n=a.image;if(!c)for(b=0;b<l;b++){n[b]=0;var r=(1-Math.cos(k*b/l))/2;p[b]*=r}b=Math.PI;for(k=r=0;k<l-1;k++){if(k<=r){var y=p[k];p[k]=p[r];p[r]=y;y=n[k];n[k]=n[r];n[r]=y}for(d=l/2;d<=r;)r-=d,d/=2;r+=d}var t=1;for(r=c?1:-1;t<=l/2;){var B=Math.cos(b);var C=Math.sin(r*b);k=1;for(f=d=0;f<t;f++){for(h=f;h<l;h+=2*t){var w=h+t;y=p[w]*k-n[w]*d;var F=n[w]*k+p[w]*d;p[w]=p[h]-y;n[w]=n[h]-F;p[h]+=y;n[h]+=F}y=B*k-C*d;d=C*k+B*d;k=y}t*=2;b/=2}if(!c)for(b=
0;b<l;b++)p[b]/=l,n[b]/=l,r=Math.sqrt(p[b]*p[b]+n[b]*n[b]),k=Math.atan2(n[b],p[b]),p[b]=r,n[b]=k};Sopa.prototype.initCoord=function(a){var c=Array(3),b=Math.PI/12;127<=a&&(b*=-1);if(0==a)c[0]=c[2]=0,c[1]=1;else if(253==a)c[0]=c[2]=0,c[1]=-1;else{if(9>a||245<=a){var d=Math.PI/4;var f=Math.cos(5*b);c[1]=Math.sin(5*b);a=9>a?d*(a-1)-Math.PI:d*(252-a)}else 25>a||229<=a?(d=Math.PI/8,f=Math.cos(4*b),c[1]=Math.sin(4*b),a=25>a?d*(a-9)-Math.PI:d*(244-a)):49>a||205<=a?(d=Math.PI/12,f=Math.cos(3*b),c[1]=Math.sin(3*
b),a=49>a?d*(a-25)-Math.PI:d*(228-a)):79>a||175<=a?(d=Math.PI/15,f=Math.cos(2*b),c[1]=Math.sin(2*b),a=79>a?d*(a-49)-Math.PI:d*(204-a)):111>a||143<=a?(d=Math.PI/16,f=Math.cos(b),c[1]=Math.sin(b),a=111>a?d*(a-79)-Math.PI:d*(174-a)):(d=Math.PI/16,f=1,c[1]=0,a=127>a?d*(a-111)-Math.PI:d*(142-a));c[0]=f*Math.sin(a);c[2]=f*Math.cos(a)}return c};Sopa.prototype.opposit=function(a){return 0==a||253<=a?a:9>a?1==a?a:10-a:25>a?9==a?a:34-a:49>a?25==a?a:74-a:79>a?49==a?a:128-a:111>a?79==a?a:190-a:127>a?111==a?a:
15+a:143>a?142==a?a:a-15:175>a?174==a?a:316-a:205>a?204==a?a:378-a:229>a?228==a?a:432-a:245>a?244==a?a:472-a:252==a?a:496-a};Sopa.prototype.modifySector=function(a,c,b){var d=0;if(253<a)return a;0!=a&&253!=a&&(d=Math.atan2(ja[a][0],ja[a][2])+c);var f=0==a||253==a?0:9>a||245<=a?Math.cos(5*Math.PI/12):25>a||229<=a?Math.cos(Math.PI/3):49>a||205<=a?Math.cos(Math.PI/4):79>a||175<=a?Math.cos(Math.PI/6):111>a||143<=a?Math.cos(Math.PI/12):1;c=[];c[0]=f*Math.sin(d);c[2]=f*Math.cos(d);c[1]=ja[a][1];if(0!=b){f=
c[0];a=c[1];var h=c[2];f=Math.sqrt(f*f+h*h);b=Math.atan2(a,f)+b;a=Math.sqrt(f*f+a*a);c[0]=a*Math.cos(b)*Math.sin(d);c[2]=a*Math.cos(b)*Math.cos(d);c[1]=a*Math.sin(b)}return this.calcSector(c)};Sopa.prototype.calcSector=function(a){var c=2*Math.PI;if(a[1]>=Math.sin(11*Math.PI/24))return 0;if(a[1]<=-Math.sin(11*Math.PI/24))return 253;var b=Math.atan2(-a[0],-a[2]);a[1]>=Math.sin(3*Math.PI/8)?(0>b&&(b+=c),a=1+b/(Math.PI/4)):a[1]<=-Math.sin(3*Math.PI/8)?a=249-b/(Math.PI/4):a[1]>=Math.sin(7*Math.PI/24)?
(0>b&&(b+=c),a=9+b/(Math.PI/8)):a[1]<=-Math.sin(7*Math.PI/24)?a=237-b/(Math.PI/8):a[1]>=Math.sin(5*Math.PI/24)?(0>b&&(b+=c),a=25+b/(Math.PI/12)):a[1]<=-Math.sin(5*Math.PI/24)?a=217-b/(Math.PI/12):a[1]>=Math.sin(Math.PI/8)?(0>b&&(b+=c),a=49+b/(Math.PI/15)):a[1]<=-Math.sin(Math.PI/8)?a=190-b/(Math.PI/15):a[1]>=Math.sin(Math.PI/24)?(0>b&&(b+=c),a=79+b/(Math.PI/16)):a=a[1]<=-Math.sin(Math.PI/24)?159-b/(Math.PI/16):0>b?127-b/(Math.PI/16):b==Math.PI?142:111+b/(Math.PI/16);return a};Sopa.prototype.polar=
function(a,c,b){var d=Array(3);d[0]=c[0]+b[0];d[1]=c[1]+b[1];d[2]=c[2]+b[2];var f=Math.sqrt(d[0]*d[0]+d[1]*d[1]+d[2]*d[2]);0<f&&(d[0]/=f,d[1]/=f,d[2]/=f);c=c[0]*b[0]+c[1]*b[1]+c[2]*b[2];1<c?c=1:-1>c&&(c=-1);c=Math.cos(Math.acos(c)/2);a=d[0]*a[0]+d[1]*a[1]+d[2]*a[2];1<a?a=1:-1>a&&(a=-1);d=Math.acos(a);a=Math.PI*Math.cos(d)*c-Math.PI;a/=2;if(1==Z)var h=(1+Math.cos(a))/2;else 2==Z?(h=Math.PI*Math.sin(d)*c*7/18,h=(1+Math.cos(a))*Math.cos(h)/2):3==Z&&(h=Math.PI*Math.sin(d)*c,a<-Aa?h=0:(h=(1+Math.cos(a))*
Math.cos(11*h/18)*Math.cos(h/2)*Math.cos(5*h/9)/2,h*=(1+Math.cos(a))/2));return Math.abs(h)};Sopa.prototype.getUnitVector=function(a,c){var b=[a[0]+c[0],a[1]+c[1],a[2]+c[2]];var d=a[0]*c[0]+a[1]*c[1]+a[2]*c[2];1<d?b.push(0):-1>d?b.push(Aa):b.push(Math.acos(d)/2);d=Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2]);0<d?(b[0]/=d,b[1]/=d,b[2]/=d):(b[0]=0,b[1]=1,b[2]=0);return b}};