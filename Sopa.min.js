Sopa=function(Da){this.urlStr=Da;var ea=navigator.userAgent.toLowerCase(),fa=!1,pa=!1,ta=!1,ua=!1,va=!0,Y=0,wa,xa,D=new XMLHttpRequest,C=new XMLHttpRequest,I=new Int16Array(130048),l=new Int16Array(130048),T,Z,G,H,q,qa=0,J,v=0,ra,U=0,V=0,W=0,aa=0,sa,K,L,ya,X,ba,ca,za,u=0,ha=36,ia=18,ja,da=Array(256),ka=[],la=[0,0,-1],ma=0,Aa=new Float32Array(2229),Ba=new Float32Array(2229),Ca=Math.PI/2;this.setup=function(){-1<ea.indexOf("iphone")||-1<ea.indexOf("ipod")||-1<ea.indexOf("ipad")?ta=!0:ea.indexOf("android");
try{ya=window.AudioContext||window.webkitAudioContext,X=new ya}catch(h){return alert("Web Audio API is not supported in this browser"),!1}ca=X.sampleRate;if(0==v)return alert("SOPA data not available!"),!1;za=ca/v;ha=36;ia=18;U=4096;J=0;ja=new Float32Array(u);var a=u/8;for(var c=0;c<u;c++)ja[c]=c<a?(.54-.46*Math.cos(Math.PI*c/a))/2:c>=u-a?(.54-.46*Math.cos(Math.PI*(u-c)/a))/2:.5;for(a=0;254>a;a++)ka[a]=this.initCoord(a);for(c=0;256>c;c++){da[c]=Array(72);for(var b=0;72>b;b++){da[c][b]=Array(36);a=
36<=b?Math.PI*(b-36)/36:-Math.PI*(36-b)/36;for(var d=-18;18>d;d++){var g=Math.PI*d/36;g=this.modifySector(c,a,g);da[c][b][d+18]=Math.floor(g)}}}ba=X.createScriptProcessor(U,2,2);return!0};this.loadDatabase=function(a,c){wa=a;xa=c;D.open("GET",wa,!0);D.responseType="arraybuffer";D.onreadystatechange=this.handleHrtf;D.send(null);C.open("GET",xa,!0);C.responseType="arraybuffer";C.onreadystatechange=this.handlePhase;C.send(null)};Sopa.prototype.handleHrtf=function(){4==D.readyState&&200==D.status&&(I=
new Int16Array(D.response),ma++,1<ma&&(pa=!0))};Sopa.prototype.handlePhase=function(){4==C.readyState&&200==C.status&&(l=new Int16Array(C.response),ma++,1<ma&&(pa=!0))};this.loadSopaData=function(){this.loadSopa(this.handleSopa)};Sopa.prototype.loadSopa=function(a){var c=this,b=new XMLHttpRequest;b.open("GET",this.urlStr,!0);b.responseType="arraybuffer";b.onreadystatechange=function(){4==b.readyState&&(200!=b.status&&4==b.readyState?alert("HTTP error "+b.status):a.call(c,b))};b.send(null)};Sopa.prototype.handleSopa=
function(a){a=a.response;var c=((new DataView(a)).byteLength-44)/4;q=new Uint8Array(a,0,44);0==qa?(T=new Uint8Array(a,44,4*c),G=new Int16Array(a,44,2*c)):(Z=new Uint8Array(a,44,4*c),H=new Int16Array(a,44,2*c));0==aa&&(va=this.checkHeader()?!0:!1);qa=0==qa?1:0};Sopa.prototype.checkHeader=function(){var a=new Uint8Array(4);for(c=8;12>c;c++)a[c-8]=q[c];if(83!=a[0]||79!=a[1]||80!=a[2]||65!=a[3])return alert("Data format error!"),!1;for(c=12;15>c;c++)a[c-12]=q[c];if(102!=a[0]||109!=a[1]||116!=a[2])return alert("Data format error!"),
!1;if(16!=q[16])return alert("PCM data should be 16-bit depth!"),!1;v=q[25]&255;v*=256;v+=q[24]&255;if(22050!=v&&44100!=v)return alert("Wrong sampleRate! "+v),!1;ra=q[39];if(2>ra)return alert("Sorry, this version is not supported"),!1;if(0==u){for(var c=5;255!=T[c]&&4096>=c;)c+=4;u=c-1;if(4096<u)return alert("Something wrong!"),!1;K=new Float32Array(u);L=new Float32Array(u)}return!0};this.fftWinSize=function(){return va?u:0};this.databaseReady=function(){return pa};this.beingPlayed=function(){return fa};
this.Play=function(){this.play()};this.currentOffset=function(){return V};this.totalOffset=function(){return aa};this.getSampleRate=function(){return v};this.setLastLoop=function(a){ua=a};this.setUrl=function(a){this.urlStr=a};this.setPan=function(a){179<a?a=179:-180>a&&(a=-180);ha=Math.floor(36+a/5)};this.setTilt=function(a){89<a?a=89:-90>a&&(a=-90);ia=Math.floor(18+a/5)};this.setCardioid=function(a,c,b){Y=a;focus=void 0==c?-Math.PI:c-Math.PI;void 0==b&&(b=0);la[0]=Math.sin(focus);la[1]=Math.sin(b);
la[2]=Math.cos(focus)};Sopa.prototype.play=function(){var a=this;fa?(ba.disconnect(X.destination),ba.onaudioprocess=null,fa=!1):(sa=J=currenttime=V=W=aa=0,ba.onaudioprocess=function(c){a.Process.call(a,c)},ta&&X.createBufferSource().start(0),fa=!0,ba.connect(X.destination))};Sopa.prototype.Process=function(a){var c=u,b=2*u,d=c/2,g=c/2,h=1/ca,Ea=44100*c/(512*v),k,n,p=new Float32Array(c),t=new Float32Array(c),na=new Float32Array(c),oa=new Float32Array(c),D=a.outputBuffer.getChannelData(0);a=a.outputBuffer.getChannelData(1);
var E=sa-W,F=Aa.subarray(0,E);D.set(F,0);F=Ba.subarray(0,E);a.set(F,0);W+=E;currenttime=W/ca;F=Math.ceil((U-E)/(za*d));for(var C=0;C<F;C++){var m=2*V;if(0==J)if(m+b>G.length){var r=G.subarray(m,G.length);var e=null!=H?H.subarray(0,m+b-G.length):G.subarray(0,m+b-G.length);var x=new Int16Array(r.length+e.length);x.set(r);x.set(e,r.length)}else x=G.subarray(m,m+b);else m+b>H.length?(r=H.subarray(m,H.length),e=G.subarray(0,m+b-H.length),x=new Int16Array(r.length+e.length),x.set(r),x.set(e,r.length)):
x=H.subarray(m,m+b);r=new Float32Array(u);var A=new Float32Array(u);for(e=0;e<u;e++)r[e]=x[2*e+1];e={real:r,image:A};this.fastFt(e,!1);x=2*m;var q=x+c;t[g]=r[g]*Math.cos(A[g]);p[g]=r[g]*Math.cos(A[g]);oa[g]=r[g]*Math.sin(A[g]);na[g]=r[g]*Math.sin(A[g]);for(e=0;e<g;e++){m=c-e;var y=Math.floor(e/Ea);var w=0==y?y:512-y;var z=0==J?0==e%2?T[x+2*e+1]:T[x+2*(e-1)]:0==e%2?Z[x+2*e+1]:Z[x+2*(e-1)];var B=3>ra?z:0==J?0==e%2?T[q+2*e+1]:T[q+2*(e-1)]:0==e%2?Z[q+2*e+1]:Z[q+2*(e-1)];if(0==y){if(B=y=r[e],w=z=A[e],
0<e){var N=k=r[m];var O=n=A[m]}}else if(254<=z&&254<=B)B=y=r[e],w=z=A[e],N=k=r[m],O=n=A[m];else{253<z?z=B:253<B&&(B=z);z=da[z][ha][ia];N=this.opposit(z);B=da[B][ha][ia];O=this.opposit(B);0<Y?(k=this.initCoord(z),n=this.initCoord(B),k=this.polar(la,k,n)):k=1;var M=k/2048;var P=512*z+y;var Q=512*z+w;var f=I[P]*M;var R=512*B+y;var S=512*B+w;f+=I[R]*M;f/=2;B=r[e]*f;f=l[P]/1E4;f+=l[R]/1E4;f/=2;31416<Math.abs(l[P]-l[R])&&(f=0>f?f+Math.PI:f-Math.PI);z=A[e]+f+0;f=I[Q]*M;f+=I[S]*M;f/=2;k=r[m]*f;f=l[Q]/1E4;
f+=l[S]/1E4;f/=2;31416<Math.abs(l[Q]-l[S])&&(f=0>f?f+Math.PI:f-Math.PI);n=A[m]+f-0;P=512*N+y;Q=512*N+w;f=I[P]*M;R=512*O+y;S=512*O+w;f+=I[R]*M;f/=2;y=r[e]*f;f=l[P]/1E4;f+=l[R]/1E4;f/=2;31416<Math.abs(l[P]-l[R])&&(f=0>f?f+Math.PI:f-Math.PI);w=A[e]+f+0;f=I[Q]*M;f+=I[S]*M;f/=2;N=r[m]*f;f=l[Q]/1E4;f+=l[S]/1E4;f/=2;31416<Math.abs(l[Q]-l[S])&&(f=0>f?f+Math.PI:f-Math.PI);O=A[m]+f-0}t[e]=y*Math.cos(w);p[e]=B*Math.cos(z);oa[e]=y*Math.sin(w);na[e]=B*Math.sin(z);0<e&&(t[m]=N*Math.cos(O),p[m]=k*Math.cos(n),oa[m]=
N*Math.sin(O),na[m]=k*Math.sin(n))}e={real:t,image:oa};this.fastFt(e,!0);e={real:p,image:na};this.fastFt(e,!0);for(e=0;e<c;e++)t[e]*=ja[e],p[e]*=ja[e],K[e]+=t[e],L[e]+=p[e];for(e=0;e<d;e++){r=K[e+1]/32768;A=L[e+1]/32768;m=K[e]/32768;x=L[e]/32768;for(q=aa/v;currenttime<q;)w=(q-currenttime)*v,y=m*w+r*(1-w),w=x*w+A*(1-w),E<U?(D[E]=y,a[E]=w,W++,currenttime=W/ca):(Aa[E-U]=y,Ba[E-U]=w,currenttime+=h),E++,sa++;aa++}e=K.subarray(d);K=new Float32Array(u);K.set(e,0);e=L.subarray(d);L=new Float32Array(u);L.set(e,
0);V+d>=(0==J?G.length/2:H.length/2)?ua?(C=F,this.play()):(V=0,J=0==J&&H?1:0):V+=d}};Sopa.prototype.fastFt=function(a,c){var b,d,g,h,l=u;var k=2*Math.PI;var n=a.real,p=a.image;if(!c)for(b=0;b<l;b++){p[b]=0;var t=(1-Math.cos(k*b/l))/2;n[b]*=t}b=Math.PI;for(k=t=0;k<l-1;k++){if(k<=t){var q=n[k];n[k]=n[t];n[t]=q;q=p[k];p[k]=p[t];p[t]=q}for(d=l/2;d<=t;)t-=d,d/=2;t+=d}var v=1;for(t=c?1:-1;v<=l/2;){var C=Math.cos(b);var E=Math.sin(t*b);k=1;for(g=d=0;g<v;g++){for(h=g;h<l;h+=2*v){var F=h+v;q=n[F]*k-p[F]*d;
var D=p[F]*k+n[F]*d;n[F]=n[h]-q;p[F]=p[h]-D;n[h]+=q;p[h]+=D}q=C*k-E*d;d=E*k+C*d;k=q}v*=2;b/=2}if(!c)for(b=0;b<l;b++)n[b]/=l,p[b]/=l,t=Math.sqrt(n[b]*n[b]+p[b]*p[b]),k=Math.atan2(p[b],n[b]),n[b]=t,p[b]=k};Sopa.prototype.initCoord=function(a){var c=Array(3),b=Math.PI/12;127<=a&&(b*=-1);if(0==a)c[0]=c[2]=0,c[1]=1;else if(253==a)c[0]=c[2]=0,c[1]=-1;else{if(9>a||245<=a){var d=Math.PI/4;var g=Math.cos(5*b);c[1]=Math.sin(5*b);a=9>a?d*(a-1)-Math.PI:d*(252-a)}else 25>a||229<=a?(d=Math.PI/8,g=Math.cos(4*b),
c[1]=Math.sin(4*b),a=25>a?d*(a-9)-Math.PI:d*(244-a)):49>a||205<=a?(d=Math.PI/12,g=Math.cos(3*b),c[1]=Math.sin(3*b),a=49>a?d*(a-25)-Math.PI:d*(228-a)):79>a||175<=a?(d=Math.PI/15,g=Math.cos(2*b),c[1]=Math.sin(2*b),a=79>a?d*(a-49)-Math.PI:d*(204-a)):111>a||143<=a?(d=Math.PI/16,g=Math.cos(b),c[1]=Math.sin(b),a=111>a?d*(a-79)-Math.PI:d*(174-a)):(d=Math.PI/16,g=1,c[1]=0,a=127>a?d*(a-111)-Math.PI:d*(142-a));c[0]=g*Math.sin(a);c[2]=g*Math.cos(a)}return c};Sopa.prototype.opposit=function(a){return 0==a||253<=
a?a:9>a?1==a?a:10-a:25>a?9==a?a:34-a:49>a?25==a?a:74-a:79>a?49==a?a:128-a:111>a?79==a?a:190-a:127>a?111==a?a:15+a:143>a?142==a?a:a-15:175>a?174==a?a:316-a:205>a?204==a?a:378-a:229>a?228==a?a:432-a:245>a?244==a?a:472-a:252==a?a:496-a};Sopa.prototype.modifySector=function(a,c,b){var d=0;if(253<a)return a;0!=a&&253!=a&&(d=Math.atan2(ka[a][0],ka[a][2])+c);var g=0==a||253==a?0:9>a||245<=a?Math.cos(5*Math.PI/12):25>a||229<=a?Math.cos(Math.PI/3):49>a||205<=a?Math.cos(Math.PI/4):79>a||175<=a?Math.cos(Math.PI/
6):111>a||143<=a?Math.cos(Math.PI/12):1;c=[];c[0]=g*Math.sin(d);c[2]=g*Math.cos(d);c[1]=ka[a][1];if(0!=b){g=c[0];a=c[1];var h=c[2];g=Math.sqrt(g*g+h*h);b=Math.atan2(a,g)+b;a=Math.sqrt(g*g+a*a);c[0]=a*Math.cos(b)*Math.sin(d);c[2]=a*Math.cos(b)*Math.cos(d);c[1]=a*Math.sin(b)}return this.calcSector(c)};Sopa.prototype.calcSector=function(a){var c=2*Math.PI;if(a[1]>=Math.sin(11*Math.PI/24))return 0;if(a[1]<=-Math.sin(11*Math.PI/24))return 253;var b=Math.atan2(-a[0],-a[2]);a[1]>=Math.sin(3*Math.PI/8)?(0>
b&&(b+=c),a=1+b/(Math.PI/4)):a[1]<=-Math.sin(3*Math.PI/8)?a=249-b/(Math.PI/4):a[1]>=Math.sin(7*Math.PI/24)?(0>b&&(b+=c),a=9+b/(Math.PI/8)):a[1]<=-Math.sin(7*Math.PI/24)?a=237-b/(Math.PI/8):a[1]>=Math.sin(5*Math.PI/24)?(0>b&&(b+=c),a=25+b/(Math.PI/12)):a[1]<=-Math.sin(5*Math.PI/24)?a=217-b/(Math.PI/12):a[1]>=Math.sin(Math.PI/8)?(0>b&&(b+=c),a=49+b/(Math.PI/15)):a[1]<=-Math.sin(Math.PI/8)?a=190-b/(Math.PI/15):a[1]>=Math.sin(Math.PI/24)?(0>b&&(b+=c),a=79+b/(Math.PI/16)):a=a[1]<=-Math.sin(Math.PI/24)?
159-b/(Math.PI/16):0>b?127-b/(Math.PI/16):b==Math.PI?142:111+b/(Math.PI/16);return a};Sopa.prototype.polar=function(a,c,b){var d=Array(3);d[0]=c[0]+b[0];d[1]=c[1]+b[1];d[2]=c[2]+b[2];var g=Math.sqrt(d[0]*d[0]+d[1]*d[1]+d[2]*d[2]);0<g&&(d[0]/=g,d[1]/=g,d[2]/=g);c=c[0]*b[0]+c[1]*b[1]+c[2]*b[2];1<c?c=1:-1>c&&(c=-1);c=Math.cos(Math.acos(c)/2);a=d[0]*a[0]+d[1]*a[1]+d[2]*a[2];1<a?a=1:-1>a&&(a=-1);d=Math.acos(a);a=Math.PI*Math.cos(d)*c-Math.PI;a/=2;if(1==Y)var h=(1+Math.cos(a))/2;else 2==Y?(h=Math.PI*Math.sin(d)*
c*7/18,h=(1+Math.cos(a))*Math.cos(h)/2):3==Y&&(h=Math.PI*Math.sin(d)*c,a<-Ca?h=0:(h=(1+Math.cos(a))*Math.cos(11*h/18)*Math.cos(h/2)*Math.cos(5*h/9)/2,h*=(1+Math.cos(a))/2));return Math.abs(h)};Sopa.prototype.getUnitVector=function(a,c){var b=[a[0]+c[0],a[1]+c[1],a[2]+c[2]];var d=a[0]*c[0]+a[1]*c[1]+a[2]*c[2];1<d?b.push(0):-1>d?b.push(Ca):b.push(Math.acos(d)/2);d=Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2]);0<d?(b[0]/=d,b[1]/=d,b[2]/=d):(b[0]=0,b[1]=1,b[2]=0);return b}};