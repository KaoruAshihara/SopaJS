Sopa=function(za){this.urlStr=za;var J=navigator.userAgent.toLowerCase(),U=!1,ka=!1,pa=!1,qa=!1,ra=!0,la=0,sa,ta,K=new XMLHttpRequest,l=new XMLHttpRequest,L=new Int16Array(130048),y=new Int16Array(130048),Y,ea,E,F,u,ma=0,N,C=0,na,Z=0,aa=0,ba=0,fa=0,oa,O,P,ua,x,G,ga,va,v=0,H=36,Q=18,ia,M=Array(256),R=[],ha=[0,0,1],ja=0,wa=new Float32Array(2229),xa=new Float32Array(2229);this.setup=function(){var a,b;-1<J.indexOf("iphone")||-1<J.indexOf("ipod")||-1<J.indexOf("ipad")?pa=!0:J.indexOf("android");try{ua=
window.AudioContext||window.webkitAudioContext,x=new ua}catch(ya){return alert("Web Audio API is not supported in this browser"),!1}ga=x.sampleRate;if(0==C)return alert("SOPA data not available!"),!1;va=ga/C;H=36;Q=18;Z=4096;N=0;ia=new Float32Array(v);b=v/8;for(var c=0;c<v;c++)ia[c]=c<b?(1-Math.cos(Math.PI*c/b))/4:c>=v-b?(1-Math.cos(Math.PI*(v-c)/b))/4:.5;for(b=0;254>b;b++)R[b]=this.initCoord(b);for(c=0;256>c;c++){M[c]=Array(72);for(var f=0;72>f;f++){M[c][f]=Array(36);b=36<=f?-Math.PI*(72-f)/36:Math.PI*
f/36;for(var e=-18;18>e;e++)a=Math.PI*e/36,a=this.modifySector(c,b,a),M[c][f][e+18]=parseInt(a)}}G=x.createScriptProcessor(Z,2,2);return!0};this.loadDatabase=function(a,b){sa=a;ta=b;K.open("GET",sa,!0);K.responseType="arraybuffer";K.onreadystatechange=this.handleHrtf;K.send(null);l.open("GET",ta,!0);l.responseType="arraybuffer";l.onreadystatechange=this.handlePhase;l.send(null)};Sopa.prototype.handleHrtf=function(){4==K.readyState&&200==K.status&&(L=new Int16Array(K.response),ja++,1<ja&&(ka=!0))};
Sopa.prototype.handlePhase=function(){4==l.readyState&&200==l.status&&(y=new Int16Array(l.response),ja++,1<ja&&(ka=!0))};this.loadSopaData=function(){this.loadSopa(this.handleSopa)};Sopa.prototype.loadSopa=function(a){var b=this,c=new XMLHttpRequest;c.open("GET",this.urlStr,!0);c.responseType="arraybuffer";c.onreadystatechange=function(){4==c.readyState&&(200!=c.status&&4==c.readyState?alert("HTTP error "+c.status):a.call(b,c))};c.send(null)};Sopa.prototype.handleSopa=function(a){a=a.response;var b=
((new DataView(a)).byteLength-44)/4;u=new Uint8Array(a,0,44);0==ma?(Y=new Uint8Array(a,44,4*b),E=new Int16Array(a,44,2*b)):(ea=new Uint8Array(a,44,4*b),F=new Int16Array(a,44,2*b));0==fa&&(ra=this.checkHeader()?!0:!1);ma=0==ma?1:0};Sopa.prototype.checkHeader=function(){for(var a=new Uint8Array(4),b=8;12>b;b++)a[b-8]=u[b];if(83!=a[0]||79!=a[1]||80!=a[2]||65!=a[3])return alert("Data format error!"),!1;for(b=12;15>b;b++)a[b-12]=u[b];if(102!=a[0]||109!=a[1]||116!=a[2])return alert("Data format error!"),
!1;if(16!=u[16])return alert("PCM data should be 16-bit depth!"),!1;C=u[25]&255;C*=256;C+=u[24]&255;if(22050!=C&&44100!=C)return alert("Wrong sampleRate! "+C),!1;na=u[39];if(2>na)return alert("Sorry, this version is not supported"),!1;if(0==v){for(var b=5;255!=Y[b]&&4096>=b;)b+=4;v=b-1;if(4096<v)return alert("Something wrong!"),!1;O=new Float32Array(v);P=new Float32Array(v)}return!0};this.fftWinSize=function(){return ra?v:0};this.databaseReady=function(){return ka};this.beingPlayed=function(){return U};
this.Play=function(){this.play()};this.currentOffset=function(){return aa};this.totalOffset=function(){return fa};this.getSampleRate=function(){return C};this.setLastLoop=function(a){qa=a};this.setUrl=function(a){this.urlStr=a};this.setPan=function(a){179<a?a=179:-180>a&&(a=-180);H=Math.floor(36+a/5)};this.setTilt=function(a){89<a?a=89:-90>a&&(a=-90);Q=Math.floor(18+a/5)};this.setCardioid=function(a,b,c){la=a;focus=void 0==b?Math.PI:b+Math.PI;void 0==c&&(c=0);ha[0]=Math.sin(focus);ha[1]=Math.sin(c);
ha[2]=Math.cos(focus)};Sopa.prototype.play=function(){var a=this;U?(G.disconnect(x.destination),G.onaudioprocess=null,U=!1):(oa=N=currenttime=aa=ba=fa=0,G.onaudioprocess=function(b){a.Process.call(a,b)},pa&&x.createBufferSource().start(0),U=!0,G.connect(x.destination))};Sopa.prototype.Process=function(a){var b=v,c=2*v,f=b/2,e=b/2,ya=1/ga,m,t,D,ca,g,K=44100*b/(512*C),k,n,w,r,h,l=1,u=1,S,T,x,d,V=new Float32Array(b),W=new Float32Array(b),G=new Float32Array(b),J=new Float32Array(b),U=a.outputBuffer.getChannelData(0);
a=a.outputBuffer.getChannelData(1);var I=oa-ba,da=wa.subarray(0,I),z,p;U.set(da,0);da=xa.subarray(0,I);a.set(da,0);ba+=I;currenttime=ba/ga;for(var da=Math.ceil((Z-I)/(va*f)),R=0;R<da;R++){g=2*aa;0==N?g+c>E.length?(p=E.subarray(g,E.length),d=null!=F?F.subarray(0,g+c-E.length):E.subarray(0,g+c-E.length),z=new Int16Array(p.length+d.length),z.set(p),z.set(d,p.length)):z=E.subarray(g,g+c):g+c>F.length?(p=F.subarray(g,F.length),d=E.subarray(0,g+c-F.length),z=new Int16Array(p.length+d.length),z.set(p),z.set(d,
p.length)):z=F.subarray(g,g+c);p=new Float32Array(v);var B=new Float32Array(v);for(d=0;d<v;d++)p[d]=z[2*d+1];d={real:p,image:B};this.fastFt(d,!1);z=2*g;var X=z+b;W[e]=p[e]*Math.cos(B[e]);V[e]=p[e]*Math.cos(B[e]);J[e]=p[e]*Math.sin(B[e]);G[e]=p[e]*Math.sin(B[e]);for(d=0;d<e;d++){g=b-d;k=parseInt(d/K);n=0==k?k:511-k;m=0==N?0==d%2?Y[z+2*d+1]:Y[z+2*(d-1)]:0==d%2?ea[z+2*d+1]:ea[z+2*(d-1)];t=2<na?0==N?0==d%2?Y[X+2*d+1]:Y[X+2*(d-1)]:0==d%2?ea[X+2*d+1]:ea[X+2*(d-1)]:m;if(0==k)t=k=p[d],n=m=B[d],0<d&&(D=w=
p[g],h=r=B[g]);else if(254<=m&&254<=t)t=k=p[d],n=m=B[d],D=w=p[g],h=r=B[g];else{253<m?m=t:253<t&&(t=m);D=this.opposit(m);m=M[m][H][Q];ca=this.opposit(t);t=M[t][H][Q];0<la&&(w=this.initCoord(m),l=this.polar(ha,w),w=this.initCoord(t),u=this.polar(ha,w),2==la&&(l*=l,u*=u));D=0==H?M[D][H][Q]:M[D][72-H][Q];ca=0==H?M[ca][H][Q]:M[ca][72-H][Q];S=512*m+k;h=512*m+n;var A=L[S]*l/2048;T=512*t+k;x=512*t+n;var A=A+L[T]*u/2048,A=A/2,q=y[S]/1E4,q=q+y[T]/1E4,q=q/2;31415<Math.abs(y[S]-y[T])&&(q=0>q?q+Math.PI:q-Math.PI);
t=p[d]*A;m=B[d]+q;A=L[h]*l/2048;A+=L[x]*u/2048;A/=2;w=p[g]*A;q=y[h]/1E4;q+=y[x]/1E4;q/=2;r=B[g]+q;S=512*D+k;h=512*D+n;A=L[S]*l/2048;T=512*ca+k;x=512*ca+n;A+=L[T]*u/2048;A/=2;q=y[S]/1E4;q+=y[T]/1E4;q/=2;31415<Math.abs(y[S]-y[T])&&(q=0>q?q+Math.PI:q-Math.PI);k=p[d]*A;n=B[d]+q;A=L[h]*l/2048;A+=L[x]*u/2048;A/=2;D=p[g]*A;q=y[h]/1E4;q+=y[x]/1E4;q/=2;h=B[g]+q}W[d]=k*Math.cos(n);V[d]=t*Math.cos(m);J[d]=k*Math.sin(n);G[d]=t*Math.sin(m);0<d&&(W[g]=D*Math.cos(h),V[g]=w*Math.cos(r),J[g]=D*Math.sin(h),G[g]=w*
Math.sin(r))}d={real:W,image:J};this.fastFt(d,!0);d={real:V,image:G};this.fastFt(d,!0);for(d=0;d<b;d++)W[d]*=ia[d],V[d]*=ia[d],O[d]+=W[d],P[d]+=V[d];for(d=0;d<f;d++){p=O[d+1]/32768;B=P[d+1]/32768;g=O[d]/32768;z=P[d]/32768;for(X=fa/C;currenttime<X;)n=(X-currenttime)*C,k=g*n+p*(1-n),n=z*n+B*(1-n),I<Z?(U[I]=k,a[I]=n,ba++,currenttime=ba/ga):(wa[I-Z]=k,xa[I-Z]=n,currenttime+=ya),I++,oa++;fa++}d=O.subarray(f);O=new Float32Array(v);O.set(d,0);d=P.subarray(f);P=new Float32Array(v);P.set(d,0);aa+f>=(0==N?
E.length/2:F.length/2)?qa?(R=da,this.play()):(aa=0,N=0==N&&F?1:0):aa+=f}};Sopa.prototype.fastFt=function(a,b){var c,f,e,l,m,t,u,y,g,x,k,n,w=v;e=2*Math.PI;var r=a.real,h=a.image;if(!b)for(c=0;c<w;c++)h[c]=0,f=(1-Math.cos(e*c/w))/2,r[c]*=f;c=Math.PI;for(e=f=0;e<w-1;e++){e<=f&&(m=r[e],r[e]=r[f],r[f]=m,m=h[e],h[e]=h[f],h[f]=m);for(l=w/2;l<=f;)f-=l,l/=2;f+=l}g=1;for(f=b?1:-1;g<=w/2;){t=Math.cos(c);u=Math.sin(f*c);e=1;for(x=l=0;x<g;x++){for(k=x;k<w;k+=2*g)n=k+g,m=r[n]*e-h[n]*l,y=h[n]*e+r[n]*l,r[n]=r[k]-
m,h[n]=h[k]-y,r[k]+=m,h[k]+=y;m=t*e-u*l;l=u*e+t*l;e=m}g*=2;c/=2}if(!b)for(c=0;c<w;c++)r[c]/=w,h[c]/=w,f=Math.sqrt(r[c]*r[c]+h[c]*h[c]),e=Math.atan2(h[c],r[c]),r[c]=f,h[c]=e};Sopa.prototype.initCoord=function(a){var b=Array(3),c,f,e=Math.PI/12;127<=a&&(e*=-1);0==a?(b[0]=b[2]=0,b[1]=1):253==a?(b[0]=b[2]=0,b[1]=-1):(9>a||245<=a?(c=Math.PI/4,f=Math.cos(5*e),9>a?(b[1]=Math.sin(5*e),a=c*(a-1)-Math.PI):(b[1]=Math.sin(-5*e),a=c*(252-a))):25>a||229<=a?(c=Math.PI/8,f=Math.cos(4*e),25>a?(b[1]=Math.sin(4*e),
a=c*(a-9)-Math.PI):(b[1]=Math.sin(-4*e),a=c*(244-a))):49>a||205<=a?(c=Math.PI/12,f=Math.cos(3*e),49>a?(b[1]=Math.sin(3*e),a=c*(a-25)-Math.PI):(b[1]=Math.sin(-3*e),a=c*(228-a))):79>a||175<=a?(c=Math.PI/15,f=Math.cos(2*e),79>a?(b[1]=Math.sin(2*e),a=c*(a-49)-Math.PI):(b[1]=Math.sin(-2*e),a=c*(204-a))):111>a||143<=a?(c=Math.PI/16,f=Math.cos(e),111>a?(b[1]=Math.sin(e),a=c*(a-79)-Math.PI):(b[1]=Math.sin(-e),a=c*(174-a))):(c=Math.PI/16,f=1,b[1]=0,a=127>a?c*(a-111)-Math.PI:c*(142-a)),b[0]=f*Math.sin(a),b[2]=
f*Math.cos(a));return b};Sopa.prototype.opposit=function(a){return 0==a||253<=a?a:9>a?1==a?a:10-a:25>a?9==a?a:34-a:49>a?25==a?a:74-a:79>a?49==a?a:128-a:111>a?79==a?a:190-a:127>a?111==a?a:15+a:143>a?142==a?a:a-15:175>a?174==a?a:316-a:205>a?204==a?a:378-a:229>a?228==a?a:432-a:245>a?244==a?a:472-a:252==a?a:496-a};Sopa.prototype.modifySector=function(a,b,c){var f,e=0;if(253<a)return a;0!=a&&253!=a&&(e=Math.atan2(R[a][0],R[a][2])+b);f=0==a||253==a?0:9>a||245<=a?Math.cos(5*Math.PI/12):25>a||229<=a?Math.cos(Math.PI/
3):49>a||205<=a?Math.cos(Math.PI/4):79>a||175<=a?Math.cos(Math.PI/6):111>a||143<=a?Math.cos(Math.PI/12):1;b=[];b[0]=f*Math.sin(e);b[2]=f*Math.cos(e);b[1]=R[a][1];0!=c&&0!=b[2]&&(a=b[1],e=b[2],c=Math.atan2(a,e)+c,a=Math.sqrt(e*e+a*a),b[2]=a*Math.cos(c),b[1]=a*Math.sin(c));return this.calcSector(b)};Sopa.prototype.calcSector=function(a){var b,c=2*Math.PI;if(a[1]>=Math.sin(11*Math.PI/24))return 0;if(a[1]<=-Math.sin(11*Math.PI/24))return 253;b=Math.atan2(a[0],a[2]);a[1]>=Math.sin(3*Math.PI/8)?(0>b&&(b+=
c),a=1+b/(Math.PI/4)):a[1]<=-Math.sin(3*Math.PI/8)?a=249-b/(Math.PI/4):a[1]>=Math.sin(7*Math.PI/24)?(0>b&&(b+=c),a=9+b/(Math.PI/8)):a[1]<=-Math.sin(7*Math.PI/24)?a=237-b/(Math.PI/8):a[1]>=Math.sin(5*Math.PI/24)?(0>b&&(b+=c),a=25+b/(Math.PI/12)):a[1]<=-Math.sin(5*Math.PI/24)?a=217-b/(Math.PI/12):a[1]>=Math.sin(Math.PI/8)?(0>b&&(b+=c),a=49+b/(Math.PI/15)):a[1]<=-Math.sin(Math.PI/8)?a=190-b/(Math.PI/15):a[1]>=Math.sin(Math.PI/24)?(0>b&&(b+=c),a=79+b/(Math.PI/16)):a=a[1]<=-Math.sin(Math.PI/24)?159-b/
(Math.PI/16):0>b?127-b/(Math.PI/16):b==Math.PI?142:111+b/(Math.PI/16);return a};Sopa.prototype.polar=function(a,b){return(1+Math.cos(Math.acos(b[0]*a[0]+b[1]*a[1]+b[2]*a[2])))/2}};