Sopa=function(oa){this.urlStr=oa;var S=navigator.userAgent.toLowerCase(),M=!1,ea=!1,ha=!1,ia=!0,fa=0,ja,ka,r=new XMLHttpRequest,u=new XMLHttpRequest,I=new Int16Array(130048),q=new Int16Array(130048),W,ca,E,B=0,ga,X=0,T=0,N,O,pa=window.AudioContext||window.webkitAudioContext,C,F,aa,la,v=0,G=36,P=18,da,J=Array(256),K=[],ba=[0,0,1],L=0,ma=new Float32Array(2229),na=new Float32Array(2229);this.setup=function(){var a,b;-1<S.indexOf("iphone")||-1<S.indexOf("ipod")||-1<S.indexOf("ipad")?ha=!0:S.indexOf("android");
try{C=new pa}catch(g){return alert("Web Audio API is not supported in this browser"),!1}aa=C.sampleRate;if(0==B)return alert("SOPA data not available!"),!1;la=aa/B;G=36;P=18;X=4096;da=new Float32Array(v);b=v/8;for(var c=0;c<v;c++)da[c]=c<b?(1-Math.cos(Math.PI*c/b))/4:c>=v-b?(1-Math.cos(Math.PI*(v-c)/b))/4:.5;for(b=0;254>b;b++)K[b]=this.initCoord(b);for(c=0;256>c;c++){J[c]=Array(72);for(var e=0;72>e;e++){J[c][e]=Array(36);b=36<=e?-Math.PI*(72-e)/36:Math.PI*e/36;for(var f=-18;18>f;f++)a=Math.PI*f/36,
a=this.modifySector(c,b,a),J[c][e][f+18]=parseInt(a)}}F=C.createScriptProcessor(X,2,2);return!0};this.loadDatabase=function(a,b){ja=a;ka=b;r.open("GET",ja,!0);r.responseType="arraybuffer";r.onreadystatechange=this.handleHrtf;r.send(null);u.open("GET",ka,!0);u.responseType="arraybuffer";u.onreadystatechange=this.handlePhase;u.send(null)};Sopa.prototype.handleHrtf=function(){4==r.readyState&&200==r.status&&(I=new Int16Array(r.response),L++,1<L&&(ea=!0))};Sopa.prototype.handlePhase=function(){4==u.readyState&&
200==u.status&&(q=new Int16Array(u.response),L++,1<L&&(ea=!0))};this.loadSopaData=function(){this.loadSopa(this.handleSopa)};Sopa.prototype.loadSopa=function(a){var b=this,c=new XMLHttpRequest;c.open("GET",this.urlStr,!0);c.responseType="arraybuffer";c.onreadystatechange=function(){4==c.readyState&&(200!=c.status&&4==c.readyState?alert("HTTP error "+c.status):a.call(b,c))};c.send(null)};Sopa.prototype.handleSopa=function(a){var b=new DataView(a.response),c=(b.byteLength-44)/4;E=new Uint8Array(44);
ca=new Int16Array(c);W=new Uint8Array(2*c);for(a=0;44>a;a++)E[a]=b.getUint8(a);for(a=0;a<c;a++)W[2*a]=b.getUint8(45+4*a),W[2*a+1]=b.getUint8(44+4*a),ca[a]=b.getInt16(46+4*a,!0);ia=this.checkHeader()?!0:!1};Sopa.prototype.checkHeader=function(){for(var a=new Uint8Array(4),b=8;12>b;b++)a[b-8]=E[b];if(83!=a[0]||79!=a[1]||80!=a[2]||65!=a[3])return alert("Data format error!"),!1;for(b=12;15>b;b++)a[b-12]=E[b];if(102!=a[0]||109!=a[1]||116!=a[2])return alert("Data format error!"),!1;if(16!=E[16])return alert("PCM data should be 16-bit depth!"),
!1;B=E[25]&255;B*=256;B+=E[24]&255;if(22050!=B&&44100!=B)return alert("Wrong sampleRate! "+B),!1;ga=E[39];if(2>ga)return alert("Sorry, this version is not supported"),!1;for(var b=1;255!=W[b]||4096<b;)b++;v=2*b;if(4096<v)return alert("Something wrong!"),!1;N=new Float32Array(v);O=new Float32Array(v);return!0};this.fftWinSize=function(){return ia?v:0};this.databaseReady=function(){return ea};this.beingPlayed=function(){return M};this.Play=function(){this.play()};this.currentOffset=function(){return T};
this.getSampleRate=function(){return B};this.setPan=function(a){179<a?a=179:-180>a&&(a=-180);G=Math.floor(36+a/5)};this.setTilt=function(a){89<a?a=89:-90>a&&(a=-90);P=Math.floor(18+a/5)};this.setCardioid=function(a,b,c){fa=a;focus=void 0==b?Math.PI:b+Math.PI;void 0==c&&(c=0);ba[0]=Math.sin(focus);ba[1]=Math.sin(c);ba[2]=Math.cos(focus)};Sopa.prototype.play=function(){var a=this;M?(F.disconnect(C.destination),F.onaudioprocess=null,M=!1):(processed=currenttime=T=datanum=originum=0,F.onaudioprocess=
function(b){a.Process.call(a,b)},ha&&C.createBufferSource().start(0),M=!0,F.connect(C.destination))};Sopa.prototype.Process=function(a){var b=v,c=b/2,e=b/2,f=1/aa,g,l,D,Y,t,E=44100*b/(512*B),p,k,w,z,h,m=1,r=1,Q,R,u,U=new Float32Array(b),V=new Float32Array(b),C=new Float32Array(b),F=new Float32Array(b),S=a.outputBuffer.getChannelData(0);a=a.outputBuffer.getChannelData(1);var H=processed-datanum,Z=ma.subarray(0,H);S.set(Z,0);Z=na.subarray(0,H);a.set(Z,0);datanum+=H;currenttime=datanum/aa;for(var Z=
Math.ceil((X-H)/(la*c)),M=0;M<Z;M++){var d=ca.subarray(T,T+v),y=new Float32Array(v),A=new Float32Array(v);y.set(d,0);d={real:y,image:A};this.fastFt(d,!1);var K=2*T,L=K+e;V[e]=y[e]*Math.cos(A[e]);U[e]=y[e]*Math.cos(A[e]);F[e]=y[e]*Math.sin(A[e]);C[e]=y[e]*Math.sin(A[e]);for(d=0;d<e;d++)if(t=b-d,p=parseInt(d/E),k=0==p?p:511-p,d<e){g=W[K+d];l=2<ga?W[L+d]:g;if(0==p)l=p=y[d],k=g=A[d],0<d&&(D=w=y[t],h=z=A[t]);else if(254<=g&&254<=l)l=p=y[d],k=g=A[d],D=w=y[t],h=z=A[t];else{253<g?g=l:253<l&&(l=g);D=this.opposit(g);
g=J[g][G][P];Y=this.opposit(l);l=J[l][G][P];0<fa&&(w=this.initCoord(g),m=this.polar(ba,w),w=this.initCoord(l),r=this.polar(ba,w),2==fa&&(m*=m,r*=r));D=0==G?J[D][G][P]:J[D][72-G][P];Y=0==G?J[Y][G][P]:J[Y][72-G][P];Q=512*g+p;h=512*g+k;var x=I[Q]*m/2048;R=512*l+p;u=512*l+k;var x=x+I[R]*r/2048,x=x/2,n=q[Q]/1E4,n=n+q[R]/1E4,n=n/2;31415<Math.abs(q[Q]-q[R])&&(n=0>n?n+Math.PI:n-Math.PI);l=y[d]*x;g=A[d]+n;x=I[h]*m/2048;x+=I[u]*r/2048;x/=2;w=y[t]*x;n=q[h]/1E4;n+=q[u]/1E4;n/=2;z=A[t]+n;Q=512*D+p;h=512*D+k;x=
I[Q]*m/2048;R=512*Y+p;u=512*Y+k;x+=I[R]*r/2048;x/=2;n=q[Q]/1E4;n+=q[R]/1E4;n/=2;31415<Math.abs(q[Q]-q[R])&&(n=0>n?n+Math.PI:n-Math.PI);p=y[d]*x;k=A[d]+n;x=I[h]*m/2048;x+=I[u]*r/2048;x/=2;D=y[t]*x;n=q[h]/1E4;n+=q[u]/1E4;n/=2;h=A[t]+n}V[d]=p*Math.cos(k);U[d]=l*Math.cos(g);F[d]=p*Math.sin(k);C[d]=l*Math.sin(g);0<d&&(V[t]=D*Math.cos(h),U[t]=w*Math.cos(z),F[t]=D*Math.sin(h),C[t]=w*Math.sin(z))}d={real:V,image:F};this.fastFt(d,!0);d={real:U,image:C};this.fastFt(d,!0);for(d=0;d<b;d++)V[d]*=da[d],U[d]*=da[d],
N[d]+=V[d],O[d]+=U[d];for(d=0;d<c;d++){y=N[d+1]/32768;A=O[d+1]/32768;t=N[d]/32768;K=O[d]/32768;for(L=originum/B;currenttime<L;)k=(L-currenttime)*B,p=t*k+y*(1-k),k=K*k+A*(1-k),H<X?(S[H]=p,a[H]=k,datanum++,currenttime=datanum/aa):(ma[H-X]=p,na[H-X]=k,currenttime+=f),H++,processed++;originum++}d=N.subarray(c);N=new Float32Array(v);N.set(d,0);d=O.subarray(c);O=new Float32Array(v);O.set(d,0);T+b+c>=ca.length?(M=Z,this.Play()):T+=c}};Sopa.prototype.fastFt=function(a,b){var c,e,f,g,l,r,u,t,q,p,k,w,z=v;f=
2*Math.PI;var h=a.real,m=a.image;if(!b)for(c=0;c<z;c++)m[c]=0,e=(1-Math.cos(f*c/z))/2,h[c]*=e;c=Math.PI;for(f=e=0;f<z-1;f++){f<=e&&(l=h[f],h[f]=h[e],h[e]=l,l=m[f],m[f]=m[e],m[e]=l);for(g=z/2;g<=e;)e-=g,g/=2;e+=g}q=1;for(e=b?1:-1;q<=z/2;){r=Math.cos(c);u=Math.sin(e*c);f=1;for(p=g=0;p<q;p++){for(k=p;k<z;k+=2*q)w=k+q,l=h[w]*f-m[w]*g,t=m[w]*f+h[w]*g,h[w]=h[k]-l,m[w]=m[k]-t,h[k]+=l,m[k]+=t;l=r*f-u*g;g=u*f+r*g;f=l}q*=2;c/=2}if(!b)for(c=0;c<z;c++)h[c]/=z,m[c]/=z,e=Math.sqrt(h[c]*h[c]+m[c]*m[c]),f=Math.atan2(m[c],
h[c]),h[c]=e,m[c]=f};Sopa.prototype.initCoord=function(a){var b=Array(3),c,e,f=Math.PI/12;127<=a&&(f*=-1);0==a?(b[0]=b[2]=0,b[1]=1):253==a?(b[0]=b[2]=0,b[1]=-1):(9>a||245<=a?(c=Math.PI/4,e=Math.cos(5*f),9>a?(b[1]=Math.sin(5*f),a=c*(a-1)-Math.PI):(b[1]=Math.sin(-5*f),a=c*(252-a))):25>a||229<=a?(c=Math.PI/8,e=Math.cos(4*f),25>a?(b[1]=Math.sin(4*f),a=c*(a-9)-Math.PI):(b[1]=Math.sin(-4*f),a=c*(244-a))):49>a||205<=a?(c=Math.PI/12,e=Math.cos(3*f),49>a?(b[1]=Math.sin(3*f),a=c*(a-25)-Math.PI):(b[1]=Math.sin(-3*
f),a=c*(228-a))):79>a||175<=a?(c=Math.PI/15,e=Math.cos(2*f),79>a?(b[1]=Math.sin(2*f),a=c*(a-49)-Math.PI):(b[1]=Math.sin(-2*f),a=c*(204-a))):111>a||143<=a?(c=Math.PI/16,e=Math.cos(f),111>a?(b[1]=Math.sin(f),a=c*(a-79)-Math.PI):(b[1]=Math.sin(-f),a=c*(174-a))):(c=Math.PI/16,e=1,b[1]=0,a=127>a?c*(a-111)-Math.PI:c*(142-a)),b[0]=e*Math.sin(a),b[2]=e*Math.cos(a));return b};Sopa.prototype.opposit=function(a){return 0==a||253<=a?a:9>a?1==a?a:10-a:25>a?9==a?a:34-a:49>a?25==a?a:74-a:79>a?49==a?a:128-a:111>
a?79==a?a:190-a:127>a?111==a?a:15+a:143>a?142==a?a:a-15:175>a?174==a?a:316-a:205>a?204==a?a:378-a:229>a?228==a?a:432-a:245>a?244==a?a:472-a:252==a?a:496-a};Sopa.prototype.modifySector=function(a,b,c){var e,f=0;if(253<a)return a;0!=a&&253!=a&&(f=Math.atan2(K[a][0],K[a][2])+b);e=0==a||253==a?0:9>a||245<=a?Math.cos(5*Math.PI/12):25>a||229<=a?Math.cos(Math.PI/3):49>a||205<=a?Math.cos(Math.PI/4):79>a||175<=a?Math.cos(Math.PI/6):111>a||143<=a?Math.cos(Math.PI/12):1;b=[];b[0]=e*Math.sin(f);b[2]=e*Math.cos(f);
b[1]=K[a][1];0!=c&&0!=b[2]&&(a=b[1],f=b[2],c=Math.atan2(a,f)+c,a=Math.sqrt(f*f+a*a),b[2]=a*Math.cos(c),b[1]=a*Math.sin(c));return this.calcSector(b)};Sopa.prototype.calcSector=function(a){var b,c=2*Math.PI;if(a[1]>=Math.sin(11*Math.PI/24))return 0;if(a[1]<=-Math.sin(11*Math.PI/24))return 253;b=Math.atan2(a[0],a[2]);a[1]>=Math.sin(3*Math.PI/8)?(0>b&&(b+=c),a=1+b/(Math.PI/4)):a[1]<=-Math.sin(3*Math.PI/8)?a=249-b/(Math.PI/4):a[1]>=Math.sin(7*Math.PI/24)?(0>b&&(b+=c),a=9+b/(Math.PI/8)):a[1]<=-Math.sin(7*
Math.PI/24)?a=237-b/(Math.PI/8):a[1]>=Math.sin(5*Math.PI/24)?(0>b&&(b+=c),a=25+b/(Math.PI/12)):a[1]<=-Math.sin(5*Math.PI/24)?a=217-b/(Math.PI/12):a[1]>=Math.sin(Math.PI/8)?(0>b&&(b+=c),a=49+b/(Math.PI/15)):a[1]<=-Math.sin(Math.PI/8)?a=190-b/(Math.PI/15):a[1]>=Math.sin(Math.PI/24)?(0>b&&(b+=c),a=79+b/(Math.PI/16)):a=a[1]<=-Math.sin(Math.PI/24)?159-b/(Math.PI/16):0>b?127-b/(Math.PI/16):b==Math.PI?142:111+b/(Math.PI/16);return a};Sopa.prototype.polar=function(a,b){return(1+Math.cos(Math.acos(b[0]*a[0]+
b[1]*a[1]+b[2]*a[2])))/2}};