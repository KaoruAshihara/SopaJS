Sopa=function(za){this.urlStr=za;var T=navigator.userAgent.toLowerCase(),L=!1,ka=!1,pa=!1,qa=!1,ra=!0,la=0,sa,ta,I=new XMLHttpRequest,u=new XMLHttpRequest,J=new Int16Array(130048),l=new Int16Array(130048),X,da,D,E,v,ma=0,M,y=0,na,Y=0,Z=0,aa=0,ea=0,oa,N,O,ua,B,F,fa,va,w=0,G=36,P=18,ha,K=Array(256),ia=[],ga=[0,0,1],ja=0,wa=new Float32Array(2229),xa=new Float32Array(2229);this.setup=function(){var a,b;-1<T.indexOf("iphone")||-1<T.indexOf("ipod")||-1<T.indexOf("ipad")?pa=!0:T.indexOf("android");try{ua=
window.AudioContext||window.webkitAudioContext,B=new ua}catch(ya){return alert("Web Audio API is not supported in this browser"),!1}fa=B.sampleRate;if(0==y)return alert("SOPA data not available!"),!1;va=fa/y;G=36;P=18;Y=4096;M=0;ha=new Float32Array(w);b=w/8;for(var c=0;c<w;c++)ha[c]=c<b?(1-Math.cos(Math.PI*c/b))/4:c>=w-b?(1-Math.cos(Math.PI*(w-c)/b))/4:.5;for(b=0;254>b;b++)ia[b]=this.initCoord(b);for(c=0;256>c;c++){K[c]=Array(72);for(var g=0;72>g;g++){K[c][g]=Array(36);b=36<=g?-Math.PI*(72-g)/36:
Math.PI*g/36;for(var e=-18;18>e;e++)a=Math.PI*e/36,a=this.modifySector(c,b,a),K[c][g][e+18]=parseInt(a)}}F=B.createScriptProcessor(Y,2,2);return!0};this.loadDatabase=function(a,b){sa=a;ta=b;I.open("GET",sa,!0);I.responseType="arraybuffer";I.onreadystatechange=this.handleHrtf;I.send(null);u.open("GET",ta,!0);u.responseType="arraybuffer";u.onreadystatechange=this.handlePhase;u.send(null)};Sopa.prototype.handleHrtf=function(){4==I.readyState&&200==I.status&&(J=new Int16Array(I.response),ja++,1<ja&&(ka=
!0))};Sopa.prototype.handlePhase=function(){4==u.readyState&&200==u.status&&(l=new Int16Array(u.response),ja++,1<ja&&(ka=!0))};this.loadSopaData=function(){this.loadSopa(this.handleSopa)};Sopa.prototype.loadSopa=function(a){var b=this,c=new XMLHttpRequest;c.open("GET",this.urlStr,!0);c.responseType="arraybuffer";c.onreadystatechange=function(){4==c.readyState&&(200!=c.status&&4==c.readyState?alert("HTTP error "+c.status):a.call(b,c))};c.send(null)};Sopa.prototype.handleSopa=function(a){a=a.response;
var b=((new DataView(a)).byteLength-44)/4;v=new Uint8Array(a,0,44);0==ma?(X=new Uint8Array(a,44,4*b),D=new Int16Array(a,44,2*b)):(da=new Uint8Array(a,44,4*b),E=new Int16Array(a,44,2*b));0==ea&&(ra=this.checkHeader()?!0:!1);ma=0==ma?1:0};Sopa.prototype.checkHeader=function(){for(var a=new Uint8Array(4),b=8;12>b;b++)a[b-8]=v[b];if(83!=a[0]||79!=a[1]||80!=a[2]||65!=a[3])return alert("Data format error!"),!1;for(b=12;15>b;b++)a[b-12]=v[b];if(102!=a[0]||109!=a[1]||116!=a[2])return alert("Data format error!"),
!1;if(16!=v[16])return alert("PCM data should be 16-bit depth!"),!1;y=v[25]&255;y*=256;y+=v[24]&255;if(22050!=y&&44100!=y)return alert("Wrong sampleRate! "+y),!1;na=v[39];if(2>na)return alert("Sorry, this version is not supported"),!1;if(0==w){for(var b=5;255!=X[b]&&4096>=b;)b+=4;w=b-1;if(4096<w)return alert("Something wrong!"),!1;N=new Float32Array(w);O=new Float32Array(w)}return!0};this.fftWinSize=function(){return ra?w:0};this.databaseReady=function(){return ka};this.beingPlayed=function(){return L};
this.Play=function(){this.play()};this.currentOffset=function(){return Z};this.totalOffset=function(){return ea};this.getSampleRate=function(){return y};this.setLastLoop=function(a){qa=a};this.setUrl=function(a){this.urlStr=a};this.setPan=function(a){179<a?a=179:-180>a&&(a=-180);G=Math.floor(36+a/5)};this.setTilt=function(a){89<a?a=89:-90>a&&(a=-90);P=Math.floor(18+a/5)};this.setCardioid=function(a,b,c){la=a;focus=void 0==b?Math.PI:b+Math.PI;void 0==c&&(c=0);ga[0]=Math.sin(focus);ga[1]=Math.sin(c);
ga[2]=Math.cos(focus)};Sopa.prototype.play=function(){var a=this;L?(F.disconnect(B.destination),F.onaudioprocess=null,L=!1):(oa=M=currenttime=Z=aa=ea=0,F.onaudioprocess=function(b){a.Process.call(a,b)},pa&&B.createBufferSource().start(0),L=!0,F.connect(B.destination))};Sopa.prototype.Process=function(a){var b=w,c=2*w,g=b/2,e=b/2,ya=1/fa,n,t,C,ba,h,I=44100*b/(512*y),m,p,x,r,k,u=1,v=1,Q,R,S,d,U=new Float32Array(b),V=new Float32Array(b),B=new Float32Array(b),F=new Float32Array(b),T=a.outputBuffer.getChannelData(0);
a=a.outputBuffer.getChannelData(1);var H=oa-aa,ca=wa.subarray(0,H),z,q;T.set(ca,0);ca=xa.subarray(0,H);a.set(ca,0);aa+=H;currenttime=aa/fa;for(var ca=Math.ceil((Y-H)/(va*g)),L=0;L<ca;L++){h=2*Z;0==M?h+c>D.length?(q=D.subarray(h,D.length),d=null!=E?E.subarray(0,h+c-D.length):D.subarray(0,h+c-D.length),z=new Int16Array(q.length+d.length),z.set(q),z.set(d,q.length)):z=D.subarray(h,h+c):h+c>E.length?(q=E.subarray(h,E.length),d=D.subarray(0,h+c-E.length),z=new Int16Array(q.length+d.length),z.set(q),z.set(d,
q.length)):z=E.subarray(h,h+c);q=new Float32Array(w);var A=new Float32Array(w);for(d=0;d<w;d++)q[d]=z[2*d+1];d={real:q,image:A};this.fastFt(d,!1);z=2*h;var W=z+b;V[e]=q[e]*Math.cos(A[e]);U[e]=q[e]*Math.cos(A[e]);F[e]=q[e]*Math.sin(A[e]);B[e]=q[e]*Math.sin(A[e]);for(d=0;d<e;d++){h=b-d;m=parseInt(d/I);p=0==m?m:511-m;n=0==M?0==d%2?X[z+2*d+1]:X[z+2*(d-1)]:0==d%2?da[z+2*d+1]:da[z+2*(d-1)];t=2<na?0==M?0==d%2?X[W+2*d+1]:X[W+2*(d-1)]:0==d%2?da[W+2*d+1]:da[W+2*(d-1)]:n;if(0==m)t=m=q[d],p=n=A[d],0<d&&(C=x=
q[h],k=r=A[h]);else if(254<=n&&254<=t)t=m=q[d],p=n=A[d],C=x=q[h],k=r=A[h];else{253<n?n=t:253<t&&(t=n);C=this.opposit(n);n=K[n][G][P];ba=this.opposit(t);t=K[t][G][P];0<la&&(x=this.initCoord(n),u=this.polar(ga,x),x=this.initCoord(t),v=this.polar(ga,x),2==la&&(u*=u,v*=v));C=0==G?K[C][G][P]:K[C][72-G][P];ba=0==G?K[ba][G][P]:K[ba][72-G][P];Q=512*n+m;k=512*n+p;var f=J[Q]*u/2048;R=512*t+m;S=512*t+p;f+=J[R]*v/2048;f/=2;t=q[d]*f;f=l[Q]/1E4;f+=l[R]/1E4;f/=2;31415<Math.abs(l[Q]-l[R])&&(f=0>f?f+Math.PI:f-Math.PI);
n=A[d]+f;f=J[k]*u/2048;f+=J[S]*v/2048;f/=2;x=q[h]*f;f=l[k]/1E4;f+=l[S]/1E4;f/=2;31415<Math.abs(l[k]-l[S])&&(f=0>f?f+Math.PI:f-Math.PI);r=A[h]+f;Q=512*C+m;k=512*C+p;f=J[Q]*u/2048;R=512*ba+m;S=512*ba+p;f+=J[R]*v/2048;f/=2;m=q[d]*f;f=l[Q]/1E4;f+=l[R]/1E4;f/=2;31415<Math.abs(l[Q]-l[R])&&(f=0>f?f+Math.PI:f-Math.PI);p=A[d]+f;f=J[k]*u/2048;f+=J[S]*v/2048;f/=2;C=q[h]*f;f=l[k]/1E4;f+=l[S]/1E4;f/=2;31415<Math.abs(l[k]-l[S])&&(f=0>f?f+Math.PI:f-Math.PI);k=A[h]+f}V[d]=m*Math.cos(p);U[d]=t*Math.cos(n);F[d]=m*
Math.sin(p);B[d]=t*Math.sin(n);0<d&&(V[h]=C*Math.cos(k),U[h]=x*Math.cos(r),F[h]=C*Math.sin(k),B[h]=x*Math.sin(r))}d={real:V,image:F};this.fastFt(d,!0);d={real:U,image:B};this.fastFt(d,!0);for(d=0;d<b;d++)V[d]*=ha[d],U[d]*=ha[d],N[d]+=V[d],O[d]+=U[d];for(d=0;d<g;d++){q=N[d+1]/32768;A=O[d+1]/32768;h=N[d]/32768;z=O[d]/32768;for(W=ea/y;currenttime<W;)p=(W-currenttime)*y,m=h*p+q*(1-p),p=z*p+A*(1-p),H<Y?(T[H]=m,a[H]=p,aa++,currenttime=aa/fa):(wa[H-Y]=m,xa[H-Y]=p,currenttime+=ya),H++,oa++;ea++}d=N.subarray(g);
N=new Float32Array(w);N.set(d,0);d=O.subarray(g);O=new Float32Array(w);O.set(d,0);Z+g>=(0==M?D.length/2:E.length/2)?qa?(L=ca,this.play()):(Z=0,M=0==M&&E?1:0):Z+=g}};Sopa.prototype.fastFt=function(a,b){var c,g,e,l,n,t,u,v,h,y,m,p,x=w;e=2*Math.PI;var r=a.real,k=a.image;if(!b)for(c=0;c<x;c++)k[c]=0,g=(1-Math.cos(e*c/x))/2,r[c]*=g;c=Math.PI;for(e=g=0;e<x-1;e++){e<=g&&(n=r[e],r[e]=r[g],r[g]=n,n=k[e],k[e]=k[g],k[g]=n);for(l=x/2;l<=g;)g-=l,l/=2;g+=l}h=1;for(g=b?1:-1;h<=x/2;){t=Math.cos(c);u=Math.sin(g*c);
e=1;for(y=l=0;y<h;y++){for(m=y;m<x;m+=2*h)p=m+h,n=r[p]*e-k[p]*l,v=k[p]*e+r[p]*l,r[p]=r[m]-n,k[p]=k[m]-v,r[m]+=n,k[m]+=v;n=t*e-u*l;l=u*e+t*l;e=n}h*=2;c/=2}if(!b)for(c=0;c<x;c++)r[c]/=x,k[c]/=x,g=Math.sqrt(r[c]*r[c]+k[c]*k[c]),e=Math.atan2(k[c],r[c]),r[c]=g,k[c]=e};Sopa.prototype.initCoord=function(a){var b=Array(3),c,g,e=Math.PI/12;127<=a&&(e*=-1);0==a?(b[0]=b[2]=0,b[1]=1):253==a?(b[0]=b[2]=0,b[1]=-1):(9>a||245<=a?(c=Math.PI/4,g=Math.cos(5*e),9>a?(b[1]=Math.sin(5*e),a=c*(a-1)-Math.PI):(b[1]=Math.sin(-5*
e),a=c*(252-a))):25>a||229<=a?(c=Math.PI/8,g=Math.cos(4*e),25>a?(b[1]=Math.sin(4*e),a=c*(a-9)-Math.PI):(b[1]=Math.sin(-4*e),a=c*(244-a))):49>a||205<=a?(c=Math.PI/12,g=Math.cos(3*e),49>a?(b[1]=Math.sin(3*e),a=c*(a-25)-Math.PI):(b[1]=Math.sin(-3*e),a=c*(228-a))):79>a||175<=a?(c=Math.PI/15,g=Math.cos(2*e),79>a?(b[1]=Math.sin(2*e),a=c*(a-49)-Math.PI):(b[1]=Math.sin(-2*e),a=c*(204-a))):111>a||143<=a?(c=Math.PI/16,g=Math.cos(e),111>a?(b[1]=Math.sin(e),a=c*(a-79)-Math.PI):(b[1]=Math.sin(-e),a=c*(174-a))):
(c=Math.PI/16,g=1,b[1]=0,a=127>a?c*(a-111)-Math.PI:c*(142-a)),b[0]=g*Math.sin(a),b[2]=g*Math.cos(a));return b};Sopa.prototype.opposit=function(a){return 0==a||253<=a?a:9>a?1==a?a:10-a:25>a?9==a?a:34-a:49>a?25==a?a:74-a:79>a?49==a?a:128-a:111>a?79==a?a:190-a:127>a?111==a?a:15+a:143>a?142==a?a:a-15:175>a?174==a?a:316-a:205>a?204==a?a:378-a:229>a?228==a?a:432-a:245>a?244==a?a:472-a:252==a?a:496-a};Sopa.prototype.modifySector=function(a,b,c){var g,e=0;if(253<a)return a;0!=a&&253!=a&&(e=Math.atan2(ia[a][0],
ia[a][2])+b);g=0==a||253==a?0:9>a||245<=a?Math.cos(5*Math.PI/12):25>a||229<=a?Math.cos(Math.PI/3):49>a||205<=a?Math.cos(Math.PI/4):79>a||175<=a?Math.cos(Math.PI/6):111>a||143<=a?Math.cos(Math.PI/12):1;b=[];b[0]=g*Math.sin(e);b[2]=g*Math.cos(e);b[1]=ia[a][1];0!=c&&0!=b[2]&&(a=b[1],e=b[2],c=Math.atan2(a,e)+c,a=Math.sqrt(e*e+a*a),b[2]=a*Math.cos(c),b[1]=a*Math.sin(c));return this.calcSector(b)};Sopa.prototype.calcSector=function(a){var b,c=2*Math.PI;if(a[1]>=Math.sin(11*Math.PI/24))return 0;if(a[1]<=
-Math.sin(11*Math.PI/24))return 253;b=Math.atan2(a[0],a[2]);a[1]>=Math.sin(3*Math.PI/8)?(0>b&&(b+=c),a=1+b/(Math.PI/4)):a[1]<=-Math.sin(3*Math.PI/8)?a=249-b/(Math.PI/4):a[1]>=Math.sin(7*Math.PI/24)?(0>b&&(b+=c),a=9+b/(Math.PI/8)):a[1]<=-Math.sin(7*Math.PI/24)?a=237-b/(Math.PI/8):a[1]>=Math.sin(5*Math.PI/24)?(0>b&&(b+=c),a=25+b/(Math.PI/12)):a[1]<=-Math.sin(5*Math.PI/24)?a=217-b/(Math.PI/12):a[1]>=Math.sin(Math.PI/8)?(0>b&&(b+=c),a=49+b/(Math.PI/15)):a[1]<=-Math.sin(Math.PI/8)?a=190-b/(Math.PI/15):
a[1]>=Math.sin(Math.PI/24)?(0>b&&(b+=c),a=79+b/(Math.PI/16)):a=a[1]<=-Math.sin(Math.PI/24)?159-b/(Math.PI/16):0>b?127-b/(Math.PI/16):b==Math.PI?142:111+b/(Math.PI/16);return a};Sopa.prototype.polar=function(a,b){return(1+Math.cos(Math.acos(b[0]*a[0]+b[1]*a[1]+b[2]*a[2])))/2}};